# =====================================================================
# AUTO-DETECT & ENABLE REMOTE DESKTOP (RDP) + DISABLE NLA (IF NEEDED)
# =====================================================================

Write-Host "`n=== Remote Desktop Configuration Script ===`n"

# --- Registry Paths ---
$RDPKey = 'HKLM:\System\CurrentControlSet\Control\Terminal Server'
$NLAKey = 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp'

# --- Get Current Settings ---
$fDenyTSConnections = (Get-ItemProperty -Path $RDPKey -Name fDenyTSConnections -ErrorAction SilentlyContinue).fDenyTSConnections
$UserAuth = (Get-ItemProperty -Path $NLAKey -Name UserAuthentication -ErrorAction SilentlyContinue).UserAuthentication

# --- Interpret Current State ---
if ($fDenyTSConnections -eq 1) {
    Write-Host "‚ùå Remote Desktop is currently DISABLED."
} elseif ($fDenyTSConnections -eq 0) {
    Write-Host "‚úÖ Remote Desktop is currently ENABLED."
} else {
    Write-Host "‚ö†Ô∏è Remote Desktop state unknown (registry value missing)."
}

if ($UserAuth -eq 1) {
    Write-Host "üîí Network Level Authentication (NLA) is currently ENABLED."
} elseif ($UserAuth -eq 0) {
    Write-Host "üîì NLA is currently DISABLED."
} else {
    Write-Host "‚ö†Ô∏è NLA state unknown (registry value missing)."
}

# --- Enable RDP if needed ---
if ($fDenyTSConnections -ne 0) {
    Write-Host "`n‚û°Ô∏è Enabling Remote Desktop..."
    Set-ItemProperty -Path $RDPKey -Name fDenyTSConnections -Value 0
} else {
    Write-Host "`n‚úîÔ∏è Remote Desktop already enabled."
}

# --- Disable NLA if enabled ---
if ($UserAuth -ne 0) {
    Write-Host "‚û°Ô∏è Disabling Network Level Authentication..."
    Set-ItemProperty -Path $NLAKey -Name UserAuthentication -Value 0
} else {
    Write-Host "‚úîÔ∏è NLA already disabled."
}

# --- Enable Windows Firewall Rule ---
Write-Host "`n‚û°Ô∏è Ensuring Remote Desktop firewall rule is enabled..."
Enable-NetFirewallRule -DisplayGroup "Remote Desktop" | Out-Null

# --- Restart the RDP service to apply changes ---
Write-Host "‚û°Ô∏è Restarting Remote Desktop Services..."
Restart-Service -Name TermService -Force

# --- Final Check ---
$fDenyTSConnections = (Get-ItemProperty -Path $RDPKey -Name fDenyTSConnections).fDenyTSConnections
$UserAuth = (Get-ItemProperty -Path $NLAKey -Name UserAuthentication).UserAuthentication

Write-Host "`n=== FINAL STATUS ==="
Write-Host "Remote Desktop: " -NoNewline
if ($fDenyTSConnections -eq 0) { Write-Host "‚úÖ ENABLED" -ForegroundColor Green } else { Write-Host "‚ùå DISABLED" -ForegroundColor Red }

Write-Host "Network Level Authentication: " -NoNewline
if ($UserAuth -eq 0) { Write-Host "üîì DISABLED" -ForegroundColor Yellow } else { Write-Host "üîí ENABLED" -ForegroundColor Green }

Write-Host "`n‚úÖ All done! Remote Desktop is ready to accept connections."
